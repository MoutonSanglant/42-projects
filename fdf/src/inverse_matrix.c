/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   inverse_matrix.c                                   :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: tdefresn <tdefresn@student.42.fr>          +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2016/02/02 13:37:44 by tdefresn          #+#    #+#             */
/*   Updated: 2016/02/02 18:00:32 by tdefresn         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "fdf.h"

static void		inv_col_1(t_mat4x4 *m, float *inv)
{
	inv[0] = (*m)[5] * (*m)[10] * (*m)[15]
		- (*m)[5] * (*m)[11] * (*m)[14]
		- (*m)[9] * (*m)[6] * (*m)[15]
		+ (*m)[9] * (*m)[7] * (*m)[14]
		+ (*m)[13] * (*m)[6] * (*m)[11]
		- (*m)[13] * (*m)[7] * (*m)[10];
	inv[4] = -(*m)[4] * (*m)[10] * (*m)[15]
		+ (*m)[4] * (*m)[11] * (*m)[14]
		+ (*m)[8] * (*m)[6] * (*m)[15]
		- (*m)[8] * (*m)[7] * (*m)[14]
		- (*m)[12] * (*m)[6] * (*m)[11]
		+ (*m)[12] * (*m)[7] * (*m)[10];
	inv[8] = (*m)[4] * (*m)[9] * (*m)[15]
		- (*m)[4] * (*m)[11] * (*m)[13]
		- (*m)[8] * (*m)[5] * (*m)[15]
		+ (*m)[8] * (*m)[7] * (*m)[13]
		+ (*m)[12] * (*m)[5] * (*m)[11]
		- (*m)[12] * (*m)[7] * (*m)[9];
	inv[12] = -(*m)[4] * (*m)[9] * (*m)[14]
		+ (*m)[4] * (*m)[10] * (*m)[13]
		+ (*m)[8] * (*m)[5] * (*m)[14]
		- (*m)[8] * (*m)[6] * (*m)[13]
		- (*m)[12] * (*m)[5] * (*m)[10]
		+ (*m)[12] * (*m)[6] * (*m)[9];
}

static void		inv_col_2(t_mat4x4 *m, float *inv)
{
	inv[1] = -(*m)[1] * (*m)[10] * (*m)[15]
		+ (*m)[1] * (*m)[11] * (*m)[14]
		+ (*m)[9] * (*m)[2] * (*m)[15]
		- (*m)[9] * (*m)[3] * (*m)[14]
		- (*m)[13] * (*m)[2] * (*m)[11]
		+ (*m)[13] * (*m)[3] * (*m)[10];
	inv[5] = (*m)[0] * (*m)[10] * (*m)[15]
		- (*m)[0] * (*m)[11] * (*m)[14]
		- (*m)[8] * (*m)[2] * (*m)[15]
		+ (*m)[8] * (*m)[3] * (*m)[14]
		+ (*m)[12] * (*m)[2] * (*m)[11]
		- (*m)[12] * (*m)[3] * (*m)[10];
	inv[9] = -(*m)[0] * (*m)[9] * (*m)[15]
		+ (*m)[0] * (*m)[11] * (*m)[13]
		+ (*m)[8] * (*m)[1] * (*m)[15]
		- (*m)[8] * (*m)[3] * (*m)[13]
		- (*m)[12] * (*m)[1] * (*m)[11]
		+ (*m)[12] * (*m)[3] * (*m)[9];
	inv[13] = (*m)[0] * (*m)[9] * (*m)[14]
		- (*m)[0] * (*m)[10] * (*m)[13]
		- (*m)[8] * (*m)[1] * (*m)[14]
		+ (*m)[8] * (*m)[2] * (*m)[13]
		+ (*m)[12] * (*m)[1] * (*m)[10]
		- (*m)[12] * (*m)[2] * (*m)[9];
}

static void		inv_col_3(t_mat4x4 *m, float *inv)
{
	inv[2] = (*m)[1] * (*m)[6] * (*m)[15]
		- (*m)[1] * (*m)[7] * (*m)[14]
		- (*m)[5] * (*m)[2] * (*m)[15]
		+ (*m)[5] * (*m)[3] * (*m)[14]
		+ (*m)[13] * (*m)[2] * (*m)[7]
		- (*m)[13] * (*m)[3] * (*m)[6];
	inv[6] = -(*m)[0] * (*m)[6] * (*m)[15]
		+ (*m)[0] * (*m)[7] * (*m)[14]
		+ (*m)[4] * (*m)[2] * (*m)[15]
		- (*m)[4] * (*m)[3] * (*m)[14]
		- (*m)[12] * (*m)[2] * (*m)[7]
		+ (*m)[12] * (*m)[3] * (*m)[6];
	inv[10] = (*m)[0] * (*m)[5] * (*m)[15]
		- (*m)[0] * (*m)[7] * (*m)[13]
		- (*m)[4] * (*m)[1] * (*m)[15]
		+ (*m)[4] * (*m)[3] * (*m)[13]
		+ (*m)[12] * (*m)[1] * (*m)[7]
		- (*m)[12] * (*m)[3] * (*m)[5];
	inv[14] = -(*m)[0] * (*m)[5] * (*m)[14]
		+ (*m)[0] * (*m)[6] * (*m)[13]
		+ (*m)[4] * (*m)[1] * (*m)[14]
		- (*m)[4] * (*m)[2] * (*m)[13]
		- (*m)[12] * (*m)[1] * (*m)[6]
		+ (*m)[12] * (*m)[2] * (*m)[5];
}

static void		inv_col_4(t_mat4x4 *m, float *inv)
{
	inv[3] = -(*m)[1] * (*m)[6] * (*m)[11]
		+ (*m)[1] * (*m)[7] * (*m)[10]
		+ (*m)[5] * (*m)[2] * (*m)[11]
		- (*m)[5] * (*m)[3] * (*m)[10]
		- (*m)[9] * (*m)[2] * (*m)[7]
		+ (*m)[9] * (*m)[3] * (*m)[6];
	inv[7] = (*m)[0] * (*m)[6] * (*m)[11]
		- (*m)[0] * (*m)[7] * (*m)[10]
		- (*m)[4] * (*m)[2] * (*m)[11]
		+ (*m)[4] * (*m)[3] * (*m)[10]
		+ (*m)[8] * (*m)[2] * (*m)[7]
		- (*m)[8] * (*m)[3] * (*m)[6];
	inv[11] = -(*m)[0] * (*m)[5] * (*m)[11]
		+ (*m)[0] * (*m)[7] * (*m)[9]
		+ (*m)[4] * (*m)[1] * (*m)[11]
		- (*m)[4] * (*m)[3] * (*m)[9]
		- (*m)[8] * (*m)[1] * (*m)[7]
		+ (*m)[8] * (*m)[3] * (*m)[5];
	inv[15] = (*m)[0] * (*m)[5] * (*m)[10]
		- (*m)[0] * (*m)[6] * (*m)[9]
		- (*m)[4] * (*m)[1] * (*m)[10]
		+ (*m)[4] * (*m)[2] * (*m)[9]
		+ (*m)[8] * (*m)[1] * (*m)[6]
		- (*m)[8] * (*m)[2] * (*m)[5];
}

void			inverse_matrix4(t_mat4x4 *m, t_mat4x4 *inv_out)
{
	float	inv[16];
	float	det;
	int		i;

	inv_col_1(m, inv);
	inv_col_2(m, inv);
	inv_col_3(m, inv);
	inv_col_4(m, inv);
	det = (*m)[0] * inv[0] + (*m)[1] * inv[4]
		+ (*m)[2] * inv[8] + (*m)[3] * inv[12];
	det = 1.0 / det;
	i = -1;
	while (++i < 16)
		(*inv_out)[i] = inv[i] * det;
}
